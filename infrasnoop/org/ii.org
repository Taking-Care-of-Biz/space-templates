#+title: Exploring Kubernetes Prow Jobs
* Load missing and most recent jobs
#+begin_src sql-mode
select * from add_prow_deck_jobs();
#+end_src

* prow.job_spec table
#+begin_src sql-mode
select count(*) from prow.job_spec;
#+end_src

#+RESULTS:
#+begin_SRC example
select count(*) from prow.job_spec;
 count
-------
  1492
(1 row)

#+end_SRC
* jobs without a cluster with dind-enabled and a testgrid-alert-email
#+begin_src sql-mode
select count(*)
  from prow.job_spec j
 where j.data->'metadata'->'labels'?'preset-dind-enabled'
   and j.data->'metadata'->'annotations'?'testgrid-alert-email'
   and data->'spec'->'cluster' is not null;
#+end_src
* annotations for first result:
#+begin_src sql-mode
with sample_job as (
  select *
    from prow.job_spec j
   where j.data->'metadata'->'labels'?'preset-dind-enabled'
     and j.data->'metadata'->'annotations'?'testgrid-alert-email'
     and data->'spec'->'cluster' is not null
   limit 1
)

select
  job,
  jsonb_object_keys(data->'metadata'->'annotations') as annotations,
       jsonb_object_keys(data->'metadata'->'labels') as labels
  from sample_job;
#+end_src

#+RESULTS:
#+begin_SRC example
with sample_job as (
  select *
    from prow.job_spec j
   where j.data->'metadata'->'labels'?'preset-dind-enabled'
     and j.data->'metadata'->'annotations'?'testgrid-alert-email'
     and data->'spec'->'cluster' is not null
   limit 1
)

select
  job,
  jsonb_object_keys(data->'metadata'->'annotations') as annotations,
       jsonb_object_keys(data->'metadata'->'labels') as labels
  from sample_job;
ERROR:  column j.data does not exist
LINE 4:    where j.data->'metadata'->'labels'?'preset-dind-enabled'
                 ^
#+end_SRC
* more ergonomic view
#+begin_src sql-mode
select job from coolview where labels contain 'x' and annotations contain 'y' and cluster is not null. --this is some pseudocode
#+end_src
* Footnotes
#+REVEAL_ROOT: https://multiplex.ii.nz
#+NOREVEAL_MULTIPLEX_SECRET: 16830253579594699605
#+NOREVEAL_MULTIPLEX_ID: f0343d4424c81b11
#+OPTIONS: toc:nil
** TODO export via clicking
** setup index.html as default
#+begin_src shell :results silent
# ln -sf ii_client.html index.html
ln -sf ii.html index.html
#+end_src
** start up a webserver
#+name: http.server
#+begin_src tmux :session ":http"
python3 -m http.server
#+end_src
